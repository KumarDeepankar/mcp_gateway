<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic Search Agent Flow Diagram</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .section h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 2rem;
            text-align: center;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .section h3 {
            color: #2d3748;
            margin: 20px 0 15px 0;
            font-size: 1.5rem;
        }


        .diagram-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .mermaid {
            text-align: center;
            min-height: 400px;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .feature-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .feature-card h4 {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .feature-card ul {
            list-style: none;
            padding-left: 0;
        }

        .feature-card li {
            padding: 5px 0;
            position: relative;
            padding-left: 20px;
        }

        .feature-card li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #90cdf4;
            font-weight: bold;
        }

        .node-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .node-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .node-card h4 {
            font-size: 1.4rem;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .node-card .purpose {
            font-weight: 600;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .node-card ul {
            list-style: none;
            padding-left: 0;
        }

        .node-card li {
            padding: 3px 0;
            position: relative;
            padding-left: 15px;
            font-size: 0.9rem;
        }

        .node-card li:before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            color: #ffd700;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .comparison-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .comparison-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .comparison-table tr:nth-child(even) {
            background-color: #f7fafc;
        }

        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 15px 0;
        }


        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .section {
                padding: 20px;
            }

            .workflow-btn {
                display: block;
                margin: 10px auto;
                width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Agentic Search Agent</h1>
            <p>LangGraph-based AI Search System with MCP Tools Integration</p>
        </div>

        <div class="section">
            <h2>üèóÔ∏è Workflow Architecture</h2>

            <div class="diagram-container">
                <h3>Optimized 5-Node Workflow (Removed Redundant Node)</h3>
                <div class="mermaid">
                    graph TD
                        A[üöÄ START] --> B[initialize_search_node]
                        B --> C[discover_tools_node]
                        C --> D[unified_planning_decision_node]

                        D --> E{Route After Unified Decision}
                        E -->|Has Plan| F[prepare_next_step_node]
                        E -->|Final Response Generated| G[üîö END]
                        E -->|Error| G

                        F --> H{Route After Step Preparation}
                        H -->|TOOL_CALL or REASONING_STEP| I[execute_tool_step_node]
                        H -->|Error/No Step| D

                        I --> D

                        style A fill:#e1f5fe
                        style B fill:#f3e5f5
                        style C fill:#f3e5f5
                        style D fill:#ff6f00,color:#fff
                        style F fill:#f3e5f5
                        style I fill:#4caf50,color:#fff
                        style G fill:#ffebee
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üîß Core Processing Nodes</h2>
            <div class="node-details">
                <div class="node-card">
                    <h4>üöÄ initialize_search_node</h4>
                    <div class="purpose">Initialize search session and state</div>
                    <ul>
                        <li>Set up thinking steps array</li>
                        <li>Initialize iteration counters (max: 5)</li>
                        <li>Handle conversation history for followup queries</li>
                        <li>Reset state flags</li>
                    </ul>
                </div>

                <div class="node-card">
                    <h4>üîç discover_tools_node</h4>
                    <div class="purpose">Fetch available tools from MCP registry</div>
                    <ul>
                        <li>Connect to MCP registry on port 8021</li>
                        <li>Retrieve available tools list</li>
                        <li>Filter enabled tools based on user selection</li>
                        <li>Handle tool discovery errors gracefully</li>
                    </ul>
                </div>


                <div class="node-card">
                    <h4>‚öôÔ∏è prepare_next_step_node</h4>
                    <div class="purpose">Prepare the next step for execution</div>
                    <ul>
                        <li>Get current step from plan</li>
                        <li>Set current_step_to_execute</li>
                        <li>Update step index</li>
                        <li>Add progress to thinking steps</li>
                    </ul>
                </div>

                <div class="node-card">
                    <h4>üîß execute_tool_step_node (OPTIMIZED)</h4>
                    <div class="purpose">Execute MCP tool calls AND reasoning steps (consolidated)</div>
                    <ul>
                        <li>Handle TOOL_CALL: Call MCP tools via mcp_tool_client</li>
                        <li>Handle REASONING_STEP: Execute reasoning and analysis</li>
                        <li>Store execution/reasoning results</li>
                        <li>Provide detailed progress updates</li>
                        <li>Handle errors gracefully</li>
                        <li>Progress to next step</li>
                    </ul>
                </div>

                <div class="node-card">
                    <h4>ü§î unified_planning_decision_node</h4>
                    <div class="purpose">Unified node for planning, decision-making, and response generation (Optimized)</div>
                    <ul>
                        <li>Analyze current state and gathered information</li>
                        <li>Decide between planning more steps or generating response</li>
                        <li>Handle iteration limits (max: 5)</li>
                        <li>Generate final response when sufficient data available</li>
                    </ul>
                </div>

            </div>
        </div>

        <div class="section">
            <h2>üè¢ State Management</h2>
            <h3>SearchAgentState Structure</h3>
            <div class="code-block">
{
    "input": str,                           # User query
    "thinking_steps": List[str],            # Progress tracking
    "available_tools": List[Dict],          # Tools from MCP registry
    "enabled_tools": List[str],             # User-selected tools
    "plan": List[PlanStep],                 # Execution plan
    "current_step_index": int,              # Current step position
    "current_step_to_execute": PlanStep,    # Active step
    "tool_execution_results": List[Dict],   # Tool call results
    "search_results": List[Dict],           # Search/reasoning results
    "conversation_history": List[Dict],     # Previous turns (last 10)
    "final_response_content": str,          # Generated response
    "final_response_generated_flag": bool,  # Completion flag
    "error_message": str,                   # Error tracking
    "current_turn_iteration_count": int,    # Iteration counter
    "max_turn_iterations": int,             # Iteration limit (5)
    "is_followup_query": bool              # Conversation context flag
}
            </div>

            <h3>PlanStep Structure</h3>
            <div class="code-block">
{
    "step_number": int,
    "step_type": str,                       # "TOOL_CALL" or "REASONING_STEP"
    "description": str,
    "tool_name": str,                       # For TOOL_CALL steps
    "tool_arguments": Dict,                 # Tool parameters
    "reasoning_content": str                # For REASONING_STEP steps
}
            </div>
        </div>

        <div class="section">
            <h2>üåü Key Features</h2>
            <div class="feature-grid">
                <div class="feature-card">
                    <h4>üîÑ Streaming & Real-time Updates</h4>
                    <ul>
                        <li>Live thinking steps before final response</li>
                        <li>Chain visualization with completion indicators</li>
                        <li>Progress tracking throughout execution</li>
                    </ul>
                </div>

                <div class="feature-card">
                    <h4>üõ†Ô∏è Tool Management</h4>
                    <ul>
                        <li>Dynamic tool discovery from MCP registry</li>
                        <li>User-configurable tool enablement</li>
                        <li>Robust error handling for tool failures</li>
                    </ul>
                </div>

                <div class="feature-card">
                    <h4>üí¨ Conversation Context</h4>
                    <ul>
                        <li>Maintains conversation history (last 10 turns)</li>
                        <li>Supports followup queries with context</li>
                        <li>Stores tool results for reference</li>
                    </ul>
                </div>

                <div class="feature-card">
                    <h4>üîí Safety & Limits</h4>
                    <ul>
                        <li>Maximum iteration limit (5) prevents infinite loops</li>
                        <li>Graceful fallback response generation</li>
                        <li>Error state handling at each node</li>
                    </ul>
                </div>

                <div class="feature-card">
                    <h4>‚ö° Performance Optimizations</h4>
                    <ul>
                        <li>Optimized 2-LLM-call workflow reduces latency</li>
                        <li>JSON parsing with fallback mechanisms</li>
                        <li>Efficient state management and serialization</li>
                    </ul>
                </div>

                <div class="feature-card">
                    <h4>üîå Integration Points</h4>
                    <ul>
                        <li>Ollama Server (llama3.2:latest) on port 11434</li>
                        <li>MCP Registry service on port 8021</li>
                        <li>FastAPI Server on port 8023</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üìä Workflow Features</h2>
            <div class="feature-grid">
                <div class="feature-card">
                    <h4>‚ö° Performance Optimized</h4>
                    <ul>
                        <li>Exactly 2 LLM calls maximum</li>
                        <li>Streamlined execution flow</li>
                        <li>Reduced latency</li>
                    </ul>
                </div>

                <div class="feature-card">
                    <h4>üß† Intelligent Decision Making</h4>
                    <ul>
                        <li>Unified planning and decision node</li>
                        <li>Dynamic plan generation</li>
                        <li>Context-aware responses</li>
                    </ul>
                </div>

                <div class="feature-card">
                    <h4>üîÑ Efficient Loop Handling</h4>
                    <ul>
                        <li>Iteration limit (5) prevents infinite loops</li>
                        <li>Smart step preparation</li>
                        <li>Graceful fallback responses</li>
                    </ul>
                </div>

                <div class="feature-card">
                    <h4>üéØ Tool-Focused Search</h4>
                    <ul>
                        <li>Prioritizes tool usage for facts</li>
                        <li>MCP tool integration</li>
                        <li>Real-time tool execution</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                fontFamily: 'Segoe UI, sans-serif',
                fontSize: '14px',
                primaryColor: '#667eea',
                primaryTextColor: '#2d3748',
                primaryBorderColor: '#4a5568',
                lineColor: '#718096',
                secondaryColor: '#f7fafc',
                tertiaryColor: '#edf2f7'
            },
            flowchart: {
                curve: 'basis',
                padding: 20
            }
        });

        // Function kept for potential future use but currently not needed
        function showWorkflow(type) {
            // Only one workflow now, so this function is simplified
            mermaid.init();
        }

        // Auto-render on page load
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.init();
        });
    </script>
</body>
</html>