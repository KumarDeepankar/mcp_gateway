<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic Search Agent Flow Diagram</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .section h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 2rem;
            text-align: center;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .section h3 {
            color: #2d3748;
            margin: 20px 0 15px 0;
            font-size: 1.5rem;
        }


        .diagram-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .mermaid {
            text-align: center;
            min-height: 400px;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .feature-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .feature-card h4 {
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .feature-card ul {
            list-style: none;
            padding-left: 0;
        }

        .feature-card li {
            padding: 5px 0;
            position: relative;
            padding-left: 20px;
        }

        .feature-card li:before {
            content: "‚úì";
            position: absolute;
            left: 0;
            color: #90cdf4;
            font-weight: bold;
        }

        .node-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .node-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .node-card h4 {
            font-size: 1.4rem;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .node-card .purpose {
            font-weight: 600;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .node-card ul {
            list-style: none;
            padding-left: 0;
        }

        .node-card li {
            padding: 3px 0;
            position: relative;
            padding-left: 15px;
            font-size: 0.9rem;
        }

        .node-card li:before {
            content: "‚Üí";
            position: absolute;
            left: 0;
            color: #ffd700;
        }

        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 15px 0;
        }


        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .section {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Agentic Search Agent</h1>
            <p>Simplified LangGraph-based AI Search System with MCP Tools Integration</p>
        </div>

        <div class="section">
            <h2>üèóÔ∏è Workflow Architecture</h2>

            <div class="diagram-container">
                <h3>Optimized 4-Node Workflow (Simplified & Efficient)</h3>
                <div class="mermaid">
                    graph TD
                        A[üöÄ START] --> B[initialize_search_node]
                        B --> C[discover_tools_node]
                        C --> D[unified_planning_decision_node]

                        D --> E{Route Decision}
                        E -->|Has Remaining Steps| F[execute_tool_step_node]
                        E -->|Final Response Generated| G[üîö END]
                        E -->|Error or No Plan| G

                        F --> D

                        style A fill:#e1f5fe
                        style B fill:#f3e5f5
                        style C fill:#f3e5f5
                        style D fill:#ff6f00,color:#fff
                        style F fill:#4caf50,color:#fff
                        style G fill:#ffebee
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üîß Core Processing Nodes</h2>
            <div class="node-details">
                <div class="node-card">
                    <h4>üöÄ initialize_search_node</h4>
                    <div class="purpose">Initialize search session and state</div>
                    <ul>
                        <li>Set up thinking steps array</li>
                        <li>Initialize iteration counters (max: 1)</li>
                        <li>Load conversation history from checkpointer</li>
                        <li>Auto-detect followup queries</li>
                        <li>Reset execution state flags</li>
                    </ul>
                </div>

                <div class="node-card">
                    <h4>üîç discover_tools_node</h4>
                    <div class="purpose">Fetch available tools from MCP registry</div>
                    <ul>
                        <li>Connect to MCP registry on port 8021</li>
                        <li>Retrieve available tools list</li>
                        <li>Filter enabled tools based on user selection</li>
                        <li>Handle tool discovery errors gracefully</li>
                    </ul>
                </div>

                <div class="node-card">
                    <h4>ü§î unified_planning_decision_node</h4>
                    <div class="purpose">Unified planning, decision-making, and response generation</div>
                    <ul>
                        <li>Analyze current state and tool results</li>
                        <li>Decide: PLAN_AND_EXECUTE or GENERATE_RESPONSE</li>
                        <li>Create execution plan with TOOL_CALL steps</li>
                        <li>Generate HTML-formatted final response</li>
                        <li>Save conversation history (plain text)</li>
                        <li>Handle iteration limits</li>
                    </ul>
                </div>

                <div class="node-card">
                    <h4>üîß execute_tool_step_node</h4>
                    <div class="purpose">Execute MCP tool calls from plan</div>
                    <ul>
                        <li>Get next step from plan using current_step_index</li>
                        <li>Call MCP tools via mcp_tool_client</li>
                        <li>Store execution results</li>
                        <li>Provide detailed progress updates</li>
                        <li>Handle errors gracefully</li>
                        <li>Increment step index</li>
                    </ul>
                </div>

            </div>
        </div>

        <div class="section">
            <h2>üè¢ State Management</h2>
            <h3>SearchAgentState Structure (Simplified)</h3>
            <div class="code-block">
{
    "input": str,                           # User query
    "conversation_id": str,                 # Session identifier
    "conversation_history": List[Dict],     # Plain text history (query + response only)
    "is_followup_query": bool,              # Auto-detected from history

    "thinking_steps": List[str],            # Progress tracking for UI
    "available_tools": List[Dict],          # Tools from MCP registry
    "enabled_tools": List[str],             # User-selected tools

    "plan": List[PlanStep],                 # Execution plan (TOOL_CALL only)
    "current_step_index": int,              # Current step position
    "tool_execution_results": List[Dict],   # Tool call results

    "final_response_content": str,          # Generated HTML response
    "final_response_generated_flag": bool,  # Completion flag
    "error_message": str,                   # Error tracking

    "current_turn_iteration_count": int,    # Iteration counter
    "max_turn_iterations": int              # Iteration limit (1)
}
            </div>

            <h3>PlanStep Structure (Simplified)</h3>
            <div class="code-block">
{
    "step_number": int,
    "step_type": "TOOL_CALL",               # Only TOOL_CALL supported
    "description": str,
    "tool_name": str,                       # Required
    "tool_arguments": Dict                  # Tool parameters
}
            </div>

            <h3>ConversationTurn Structure (Minimal)</h3>
            <div class="code-block">
{
    "query": str,                           # User query
    "response": str                         # Plain text response (HTML stripped)
}
            </div>
        </div>

        <div class="section">
            <h2>üåü Key Features</h2>
            <div class="feature-grid">
                <div class="feature-card">
                    <h4>üîÑ Conversation Management</h4>
                    <ul>
                        <li>Automatic conversation history persistence</li>
                        <li>All queries are followups by default (same session)</li>
                        <li>Plain text storage, HTML display</li>
                        <li>Keeps last 10 conversation turns</li>
                    </ul>
                </div>

                <div class="feature-card">
                    <h4>üõ†Ô∏è Tool Management</h4>
                    <ul>
                        <li>Dynamic tool discovery from MCP registry</li>
                        <li>User-configurable tool enablement</li>
                        <li>Robust error handling for tool failures</li>
                    </ul>
                </div>

                <div class="feature-card">
                    <h4>‚ö° Performance Optimizations</h4>
                    <ul>
                        <li>Removed redundant nodes (5 ‚Üí 4 nodes)</li>
                        <li>Removed search_results state field</li>
                        <li>Removed REASONING_STEP step type</li>
                        <li>Cleaner state management</li>
                    </ul>
                </div>

                <div class="feature-card">
                    <h4>üîí Safety & Limits</h4>
                    <ul>
                        <li>Maximum iteration limit prevents infinite loops</li>
                        <li>Graceful fallback response generation</li>
                        <li>Error state handling at each node</li>
                    </ul>
                </div>

                <div class="feature-card">
                    <h4>üíæ State Persistence</h4>
                    <ul>
                        <li>LangGraph MemorySaver checkpointer</li>
                        <li>Thread-based conversation tracking</li>
                        <li>Automatic state restoration</li>
                    </ul>
                </div>

                <div class="feature-card">
                    <h4>üîå Integration Points</h4>
                    <ul>
                        <li>Ollama Server (llama3.2:latest) on port 11434</li>
                        <li>MCP Registry service on port 8021</li>
                        <li>FastAPI Server on port 8023</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>üìä Simplification Benefits</h2>
            <div class="feature-grid">
                <div class="feature-card">
                    <h4>‚ö° Faster Execution</h4>
                    <ul>
                        <li>Reduced from 5 to 4 nodes</li>
                        <li>Eliminated prepare_next_step_node</li>
                        <li>Direct execution from planning node</li>
                    </ul>
                </div>

                <div class="feature-card">
                    <h4>üß† Cleaner State</h4>
                    <ul>
                        <li>Removed search_results (redundant)</li>
                        <li>Removed current_step_to_execute</li>
                        <li>Removed REASONING_STEP complexity</li>
                    </ul>
                </div>

                <div class="feature-card">
                    <h4>üîÑ Better Conversation Flow</h4>
                    <ul>
                        <li>HTML for user display</li>
                        <li>Plain text for history context</li>
                        <li>Automatic followup detection</li>
                    </ul>
                </div>

                <div class="feature-card">
                    <h4>üéØ Focused Functionality</h4>
                    <ul>
                        <li>Tool-based information gathering</li>
                        <li>AI generates responses when ready</li>
                        <li>No redundant reasoning steps</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                fontFamily: 'Segoe UI, sans-serif',
                fontSize: '14px',
                primaryColor: '#667eea',
                primaryTextColor: '#2d3748',
                primaryBorderColor: '#4a5568',
                lineColor: '#718096',
                secondaryColor: '#f7fafc',
                tertiaryColor: '#edf2f7'
            },
            flowchart: {
                curve: 'basis',
                padding: 20
            }
        });

        // Auto-render on page load
        document.addEventListener('DOMContentLoaded', function() {
            mermaid.init();
        });
    </script>
</body>
</html>
